即时通讯\(Instant Messenger，简称IM\)软件多是基于TCP/IP和UDP进行通讯的，TCP/IP和UDP都是建立在更低层的IP协议上的两种通讯传输协议。前者是以数据流的形式，将传输数据经分割、打包后，通过两台机器之间建立起的虚电路，进行连续的、双向的、严格保证数据正确性的文件传输协议。而后者是以数据报的形式，对拆分后的数据的先后到达顺序不做要求的文件传输协议。

## 1、主流的四种IM协议

XMPP（Extensible Messageing and Presence Protocol：可扩展消息与存在协议）是目前主流的四种IM（IM：instant messaging,即时消息）协议之一，其他三种分别为：即时信息和空间协议\(IMPP\)、空间和即时信息协议\(PRIM\)、针对即时通讯和空间平衡扩 充的进程开始协议SIP\(SIMPLE\)。

在这四种协议中，XMPP是最灵活的。XMPP是一种基于XML的协议，它继承了在XML环境中灵活的发展性。因此，基于XMPP的应用具有超强的可扩展 性。经过扩展以后的XMPP可以通过发送扩展的信息来处理用户的需求，以及在XMPP的顶端建立如内容发布系统和基于地址的服务等应用程 序。而且，XMPP包含了针对服务器端的软件协议，使之能与另一个进行通话，这使得开发者更容易建立客户应用程序或给一个配好系统添加功能。

## 2、IM 的通信协议

**通常IM采取的协议有xmpp、mqtt、protobuf**等数据通信和私有协议，我们来逐一分析他们的优缺点。

2.1XMPP协议：

优点：基于xml协议，容易理解，使用广泛，易于扩展。

缺点：流量大，在移动终端也耗电。交互过程复杂。多被pc时代的产品使用，不适合移动时代的IM产品，即使我们基于xmpp进行改进，简化握手过程，改进文件传输机制，但是它的基因决定了如何改进，他都不适合移动互联网时代的IM产品。就像凤姐无论怎么整容，也变成不了高圆圆一样。

2.2MQTT协议：

优点：适配多平台。

缺点：协议简单，但是需要自己扩展好友，群组等功能。

2.3私有协议：

优点：随心所欲，自己定义，流量小。

缺点：工作量巨大，扩展性差，需要考虑全面。

2.4Protobuf协议：

优点：非常小、非常快、非常简单，一条消息数据用Protobuf序列化后的大小是JSON的1/10、XML格式的1/20、是二进制序列化的1/10。

缺点：不能表示复杂的数据结构，但是对于IM来讲，已经足够。强烈推荐此协议。

补充1：强列建议使用Protobuf，理由如下

灵活、高效：灵活（方便接口更新）、高效（效率经过google的优化，传输效率比普通的XML等高很多）；

易于使用：开发人员通过按照一定的语法定义结构化的消息格式，然后送给命令行工具，工具将自动生成相关的类，可以支持java、c++、python等语言环境。通过将这些类包含在项目中，可以很轻松的调用相关方法来完成业务消息的序列化与反序列化工作。

语言支持：原生支持c++、java、python等多达10余种语言。

补充2：Protobuf主要适用于

需要和其它系统做消息交换的，对消息大小很敏感的。那么protobuf适合了，它语言无关，消息空间相对xml和json等节省很多。

小数据的场合。如果你是大数据，用它并不适合。

项目语言是c++、java、python等，因为它们可以使用google的源生类库，序列化和反序列化的效率非常高。其它的语言需要第三方或者自己写，序列化和反序列化的效率不保证。

总体而言，Protobuf还是非常好用的，被很多开源系统用于数据通信的工具，在google也是核心的基础库。

## 3.移动端有哪些难点需要解决

### 3.1. 流量：

采取哪种协议、图片缩略图、附件的压缩三点决定了流量的大小。

### 3.2. 耗电：

\(1\)流量越小，耗电越低。

\(2\)心跳策略，减少心跳次数，耗电量就会降低。

### 3.3. 心跳时长：

wifi，2G，3G，4G，移动、电信、联通,不同网络，不同运行商，NAT失效时间不一样，因此心跳的时间也就不一样。

### 3.4. 网络连接：

cmnet和cmwap下连接处理机制。

### 3.5. 网络不稳定：

移动端最大的特点就是网络不稳定，在不稳定的网络状态下，如何保证消息以最快的速度到达？如何避免重联风暴？这些既需要从整体架构考虑，也需要在移动端采取巧妙的策略加以避免。

## 4.NAT

NAT分为4种\(加上防火墙的话，多几种情况\)：

### 4.1.完全透明NAT\(Full Cone NAT\):

从相同内部主机\(IN IPX\) +端口\(IN PORTX\)发送的数据MAPING为相同的IP\(OUT IP X\)和端口\(OUT PORT X\)发送带外网.

并且 从另一个服务器\(Y\)，如果直连到MAPING的IP\(OUT IP X\)和端口\(OUT PORT X \)上，数据将会被转发到内部主机上. \(IN IPX\), \(IN PORTX\).

//也就是说进内部网的数据包的SPORT，SPORT不受限制

### 4.2.受限NAT\(Restricted Cone\),

从相同内部主机IN IPX\) +端口\(\(IN PORTX\)\)发送的数据MAPING为相同的IP\(X\)和端口发送带外网.

和完全NAT不同的是，只有当为X时，外部机器的的请求就被转发到主机IN IPX\) +端口\(\(IN PORTX\)。

也就是说进内部网的数据包的，SPORT不受限制，SIP受限制，只能为NAT MAP数据的IP

### 4.3端口受限NAT\(Port Restricted Cone\)

和受限NAT不同的是，只有当外部主动请求的的源IP和端口，等于内部网发送的请求的目的IP和端口。

### 4.4对称NAT\(Symmetric\)

如果发送的包的目的IP AND PORT，那么MAPPING IP AND PORT，将相同。

内部网同一台机器，同一个端口 如果目的地址不同，那么MAPPING的端口也不同，

所以只有他主动连的服务器才可能知道他的MAPPING后端口，别的服务器如果想

连他只能靠猜测端口。

### 4.5总结

前面3重NAT，MAPING PORT 和 IP，是根据发送包的的内部网的IP和端口决定的。

如果数据的内网IP和端口相同，那么MAPPING后的端口和地址是固定。

这个功能为我们的穿越提供了很好条件。

第4种NAT，打洞后的MAPPING 地址和端口将变地不可靠。很难穿越。

注意SERVERA，和SERVERB是两个公网地址，而不是两台机器，

## 一、IM技术概念

IM技术全称Instant Messaging，中文翻译“即时通讯”，它是一种使人们能在网上识别在线用户并与他们实时交换消息的技术，是电子邮件发明以来迅速崛起的在线通讯方式。

IM的出现和互联网有着密不可分的关系，IM完全基于TCP/IP网络协议族实现，而TCP/IP协议族则是整个互联网得以实现的技术基础。 最早出现即时通讯协议是IRC\(Internet Relay Chat\)，但是可惜的是它仅能单纯的使用文字、符号的方式通过互联网进行交谈和沟通。随着互连网变得高度发达，即时通讯也变得远不止聊天这么简单，自1996年第一个IM产品ICQ发明后，IM的技术和功能也开始基本成型，语音、视频、文件共享、短信发送等高级信息交换功能都可以在IM工具上实现，于是功能强大的IM软件便足以搭建一个完整的通信交流平台。目前最具代表性的几款的IM通讯软件有MSN、Google Talk、Yahoo、Messenger 、腾讯QQ等。

## 二、IM技术原理和工作方式

典型的IM工作方式如下：登陆IM通讯中心\(IM通讯服务器\)，获取一个自建立的历史的交流对象列表\(好友列表\)，然后自身标志为在线状态，当好友列表中的某人在任何时候登录上线并试图通过你的计算机联系你时，IM系统会发一个消息提醒你，然后你能与他建立一个聊天会话通道进行各种消息如键入文字、通过语音等的交流，

从技术上来说，IM的基本技术原理如下：

IM服务器

登陆或注销 登陆或注销

用户A通过列表找到B，用户B获得的消息并与之交谈

通过IM服务器指引建立与B单独的通讯通道

第一步，用户A输入自己的用户名和密码登录IM服务器，服务器通过读取用户数据库来验证用户身份，如果验证通过，登记用户A的IP地址、IM客户端软件的版本号及使用的TCP/UDP端口号，然后返回用户A登录成功的标志，此时用户A在IM系统中的状态为在线\(Online Presence\)。

第二步，根据用户A存储在IM服务器上的好友列表\(Buddy List\)，服务器将用户A在线的相关信息发送给也同时在线的IM好友的PC机，这些信息包括在线状态、IP地址、IM客户端使用的TCP端口\(Port\)号等，IM好友的客户端收到此信息后将在予以提示。

第三步是IM服务器把用户A存储在服务器上的好友列表及相关信息回送到他的客户端机，这些信息包括也在线状态、IP地址、IM客户端使用的TCP端口\(Port\)号等信息，用户A的IM客户端收到后将显示这些好友列表及其在线状态。

## 三、IM通讯方式

1.在线直接通讯

如果用户A想与他的在线好友用户B聊天，他将直接通过服务器发送过来的用户B的IP地址、TCP端口号等信息，直接向用户B的PC机发出聊天信息，用户B的IM客户端软件收到后显示在屏幕上，然后用户B再直接回复到用户A的PC机，这样双方的即时文字消息就不再IM服务器中转，而是直接通过网络进行点对点的通讯，即对等通讯方式\(Peer To Peer\)。

2.在线代理通讯

用户A与用户B的点对点通讯由于防火墙、网络速度等原因难以建立或者速度很慢，IM服务器将会主动提供消息中转服务，即用户A和用户B的即时消息全部先发送到IM服务器，再由服务器转发给对方。

3.离线代理通讯

用户A与用户B由于各种原因不能同时在线的时候，如此时A向B发送消息，IM服务器可以主动寄存A用户的消息，到B用户下一次登陆的时候，自动将消息转发给B。

4.扩展方式通讯

用户A可以通过IM服务器将信息以扩展的方式传递给B，如短信发送方式发送到B的手机，传真发送方式传递给B的电话机，以email的方式传递给B的电子邮箱等。

早期的IM系统，在IM客户端和IM服务器之间通讯采用UDP协议，UDP协议是不可靠的传输协议，而在IM客户端之间的直接通讯中，采用具备可靠传输能力的TCP协议。随着用户需求和技术环境的发展，目前主流的IM系统倾向于在IM客户端之间、IM客户端和IM服务器之间都采用TCP协议。

即时通讯相对于其他通讯方式如电话、传真、email等的最大优势就是消息传达的即时性和精确性，只要消息传递双方均在网络上可以互通，使用即时通讯软件传递消息，传递延时仅为1秒种

## 四、兴起的嵌入式IM工具。

传统的IM在统治了互联网即时通讯领域长达十年之久，以其日趋稳定的定能，与较强的用户黏着度，至今仍统治着这个巨大的市场。然而，软件行业的技术精英们，并不满足于此。他们厚积薄发，一直致力于开发出性能更为优越的即时通讯工具。当然，在功能上的不断完善，自然是一个必然的发展方向，在Web2.0时代，如何大力增强用户对网站的黏着度，而不仅仅是对于IM的拥附，已经成为他们的主攻方向了。于是，嵌入式IM工具，应运而生了。

相对以往的传统的即使沟通工具，它们需要用户下载软件包，需要用户进行安装。对于拥有IM产品的网站而言，用户在登陆网站后，不能直接使用其IM工具，对于流量与用户的黏着度，都是有一定影响的。因此在IM与网站相互依存的今天，没有哪家网络公司，愿意将IM工具孤立开来。

于是，目前，一种新型的嵌入式IM工具就应运而生了。这种IM工具，不需要下载安装，当用户登陆网页后，该IM直接嵌套在网页中，可以直接使用。

而在功能上，则一点也不输于传统的IM，无论是传统的文字沟通的速度与效率，还是近年来越来越成为IM工具必备的音频/视频功能，这种嵌入式IM都能提供非常稳定的传输。更值得一提的是，因为嵌入式IM是嵌套在网页上的，软件供应商，可以根据网站需求，设计出适合网站风格的IM产品。而不是像传统的IM工具，千篇一律，毫无个性可言。

