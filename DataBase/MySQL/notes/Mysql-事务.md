# Mysql-事务

事务(Database Transaction) ，是指作为单个逻辑工作单元执行的一系列操作，要么完全地执行，要么完全地不执行。
### ACID
ACID，是指在可靠数据库管理系统（DBMS）中，事务(Transaction)所应该具有的四个特性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。
* 原子性

    - 原子性是指事务是一个不可再分割的工作单位，事务中的操作要么都发生，要么都不发生。

    - 如，A向B转钱，在事务中的扣款和加款两条语句，要么都执行，要么都不执行。
* 一致性

    - 一致性是指事务使得系统从一个一致的状态转换到另一个一致状态。

    - 如，A和B存款总额为1000，A向B转钱，无论失败，最终A和B的存款总额依然为1000.
* 隔离性

    - 多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。

    - 数据库多个事务之间操作可能出现的问题以及事务隔离级别是这篇文章介绍的重点。
* 持久性

    - 持久性，意味着在事务完成以后，该事务所对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。

    - 即使出现了任何事故比如断电等，事务一旦提交，则持久化保存在数据库中。
### 事务的并发问题
* 赃读（Dirty Read）

    - 一个事务读取到了另外一个事务没有提交的数据

    - 事务A读取了事务B更新的数据，然后B回滚操作，那么A读取到的数据是脏数据
* 不可重复读（Nonrepeatable Read）

    - 在同一事务中，两次读取同一数据，得到内容不同

    - 事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据作了更新并提交，导致事务A多次读取同一数据时，结果不一致
* 幻读（Phantom Read）

    - 同一事务中，用同样的操作读取两次，得到的记录数不相同

    - 系统管理员A将数据库中所有学生的成绩从具体分数改为ABCDE等级，但是系统管理员B就在这个时候插入了一条具体分数的记录，当系统管理员A改结束后发现还有一条记录没有改过来，就好像发生了幻觉一样

## MySql的四中隔离级别
* Read Uncommitted（读取未提交内容）
    - 在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。
    - 读取未提交的数据，则会发生赃读
    - 会出现脏读，不可重复读，幻读

* Read Committed（读取提交内容）
    - 一个事务只能看见已经提交事务所做的改变。这是大多数数据库系统的默认隔离级别，但非MySql一个事务多次读取的过程中，另一个事务可能对同一条数据做修改并提交，导致前一个事务多次读取到的数据不一致，则会发生不可重复读
    - 会出现不可重复读，幻读

* Repeatable Read（可重读）
    - 它确保同一事务的多个实例在并发读取数据时，会看到同样的数据行。这是MySql的默认隔离级别. 但，此级别依然会发生幻读
    - 会出现幻读(但在Mysql实现的Repeatable read配合gap锁不会出现幻读！)
    
* Serializable（可串行化）
    - 它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题
    - 串行，避免以上的情况！

|隔离级别|	读数据一致性|	赃读|	不可重复读|	幻读|
|--------|--------|--------|--------|--------|
|Read Uncommitted|	最低级别，只能保证不读取物理上损坏的数据|	√|	√|	√|
|Read Committed|	语句级|	×|	√|	√|
|Repeatable Read|	事务级|	×|	×|	√|
|Serializable|	最高级别，事务级|	×|	×	|×|
低级别的隔离一般支持更高的并发处理，并拥有更低的系统开销。高级别的隔离可靠性较高，但系统开销较大。

Read uncommitted会出现的现象--->脏读：一个事务读取到另外一个事务未提交的数据
- 出现脏读的本质就是因为操作(修改)完该数据就立马释放掉锁，导致读的数据就变成了无用的或者是错误的数据。

Read committed出现的现象--->不可重复读：一个事务读取到另外一个事务已经提交的数据，也就是说一个事务可以看到其他事务所做的修改
- Read committed避免脏读的做法其实很简单：就是把释放锁的位置调整到事务提交之后，此时在事务提交前，其他进程是无法对该行数据进行读取的，包括任何操作

虚读(幻读)：是指在一个事务内读取到了别的事务插入的数据，导致前后读取不一致。

> 注：和不可重复读类似，但虚读(幻读)会读到其他事务的插入的数据，导致前后读取不一致
- MySQL的Repeatable read隔离级别加上GAP间隙锁已经处理了幻读了。