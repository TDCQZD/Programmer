# etcd集群的静态搭建
* https://www.chaindesk.cn/witbook/36/510

## 一、集群
分布式与集群 分布式（distributed）是指在多台不同的服务器中部署不同的服务模块，通过远程调用协同工作，对外提供服务。

集群（cluster）是指在多台不同的服务器中部署相同应用或服务模块，构成一个集群，通过负载均衡设备对外提供服务。

ETCD使用RAFT协议保证各个节点之间的状态一致。根据RAFT算法原理，节点数目越多，会降低集群的写性能。这是因为每一次写操作，需要集群中大多数节点将日志落盘成功后，Leader节点才能将修改内部状态机，并返回将结果返回给客户端。

也就是说在等同配置下，节点数越少，集群性能越好。显然，只部署1个节点是没什么意义的。通常，按照需求将集群节点部署为3，5，7，9个节点。

这里能选择偶数个节点吗？ 最好不要这样。原因有二：

- 偶数个节点集群不可用风险更高，表现在选主过程中，有较大概率或等额选票，从而触发下一轮选举。
- 偶数个节点集群在某些网络分割的场景下无法正常工作。试想，当网络分割发生后，将集群节点对半分割开。此时集群将无法工作。按照RAFT协议，此时集群写操作无法使得大多数节点同意，从而导致写失败，集群无法正常工作。
在安装和启动 etcd 服务的时候，各个节点需要知道集群中其他节点的信息（一般是 ip 和 port 信息）。根据你是否可以提前知道每个节点的 ip，有几种不同的启动方案：

- Static/静态：适用于有固定IP的主机节点

    (静态配置 ：在启动 etcd server 的时候，通过 --initial-cluster 参数配置好所有的节点信息)

- etcd Discovery/etcd发现：适用于DHCP环境

    (使用已有的 etcd cluster 来注册和启动，比如官方提供的 discovery.etcd.io)

- DNS Discovery/DNS发现：依赖DNS SRV记录
    (使用 DNS 启动)

每个 etcd cluster 都是有若干个 member 组成的，每个 member 是一个独立运行的 etcd 实例，单台机器上可以运行多个 member。

在正常运行的状态下，集群中会有一个 leader，其余的 member 都是 followers。leader 向 followers 同步日志，保证数据在各个 member 都有副本。leader 还会定时向所有的 member 发送心跳报文，如果在规定的时间里 follower 没有收到心跳，就会重新进行选举。

客户端所有的请求都会先发送给 leader，leader 向所有的 followers 同步日志，等收到超过半数的确认后就把该日志存储到磁盘，并返回响应客户端。

每个 etcd 服务有三大主要部分组成：raft 实现、WAL 日志存储、数据的存储和索引。WAL 会在本地磁盘（就是之前提到的 --data-dir）上存储日志内容（wal file）和快照（snapshot）。

> 官方提供了一个工具goreman，提供了Profile文件方式配置集群，简化部署。

> 实际使用时，考虑服务的可用性，一般采用多机集群。本地集群可用于测试时快速搭建服务，具体操作参考官方文档，个人推荐测试时也是用多机集群部署方案。

> 在官网上有搭建本地集群的介绍，但是意义不大，此处略过，感兴趣的话可以直接去官网查阅资料即可。

> 首先安装goreman：

    ```
    $ go get github.com/mattn/goreman
    ```
> 在etcd git存储库的基础上提供了一个procfile，以便轻松配置本地多成员集群。要启动多成员群集，请导航到etcd源树的根目录，然后执行以下操作：

    ```
    $ goreman start
    ``` 
## 二、静态配置
这里的集群模式是指完全集群模式，当然也可以在单机上通过不同的端口，部署伪集群模式，只是那样做只适合测试环境，生产环境考虑到可用性的话需要将etcd实例分布到不同的主机上，这里集群搭建有三种方式，分布是静态配置，etcd发现，dns发现。默认配置运行etcd，监听本地的2379端口，用于与client端交互，监听2380用于etcd内部交互。etcd启动时，集群模式下会用到的参数如下：
```
--name
etcd集群中的节点名，这里可以随意，可区分且不重复就行
--listen-peer-urls
监听的用于节点之间通信的url，可监听多个，集群内部将通过这些url进行数据交互(如选举，数据同步等)
--initial-advertise-peer-urls
建议用于节点之间通信的url，节点间将以该值进行通信。
--listen-client-urls
监听的用于客户端通信的url,同样可以监听多个。
--advertise-client-urls
建议使用的客户端通信url,该值用于etcd代理或etcd成员与etcd节点通信。
--initial-cluster-token etcd-cluster-1
节点的token值，设置该值后集群将生成唯一id,并为每个节点也生成唯一id,当使用相同配置文件再启动一个集群时，只要该token值不一样，etcd集群就不会相互影响。
--initial-cluster
也就是集群中所有的initial-advertise-peer-urls 的合集
--initial-cluster-state new
新建集群的标志，初始化状态使用 new，建立之后改此值为 existing
你可以使用3台真实的机器，也可以使用模拟机，此处我用的是一台宿主机(Mac系统)，以及两台虚拟机(Ubuntu16.04)，golang的版本为go1.11。
```
主机规划如下：
```
name	IP
etcd01	192.168.10.112
etcd02	192.168.10.115
etcd03	192.168.10.117
```
> 注意，这里的name是etcd集群里使用的名字，不是主机名，当然和主机名一致也是没关系的。

## 搭建方式